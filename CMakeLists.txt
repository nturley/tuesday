# I have no good reason to pick this version
cmake_minimum_required (VERSION 2.8.11)
project (tuesday C)

add_library (tuesday SHARED
    # there's a better way to do this but it wasn't being cooperative
    ${CMAKE_CURRENT_BINARY_DIR}/lexer.c
    # I definitely need this
    nvc/src/parse.c
    # identifiers
    nvc/src/ident.c
    nvc/src/common.c
    # types
    nvc/src/type.c
    # AST
    nvc/src/tree.c
    # parent of trees and types
    nvc/src/object.c
    # common.c assume_int needs this
    nvc/src/eval.c
    # objects are read/written to file
    nvc/src/fbuf.c
    # eval needs this
    nvc/src/vcode.c
    nvc/src/hash.c
    nvc/src/lib.c
    # needed by eval
    nvc/src/lower.c
    # needed by fbuf
    nvc/thirdparty/fastlz.c
    # utils has more crap than I want, so I ripped a bunch out
    nvc_patch/util.c
    # I might also need elab.c at some point
)

# GCC defaults to an ancient version of C
set_property(TARGET tuesday PROPERTY C_STANDARD 99)

target_include_directories(tuesday PRIVATE nvc/src nvc/thirdparty)

# these are usually generated by autotools, but we can fake them
target_compile_definitions(tuesday PRIVATE PACKAGE_URL="foo.bar")
target_compile_definitions(tuesday PRIVATE PACKAGE_NAME="foo.bar")
target_compile_definitions(tuesday PRIVATE PACKAGE="foo.bar")
target_compile_definitions(tuesday PRIVATE PACKAGE_VERSION="foo.bar")
target_compile_definitions(tuesday PRIVATE PACKAGE_STRING="foo.bar")
target_compile_definitions(tuesday PRIVATE PATH_SEP="/")
target_compile_definitions(tuesday PRIVATE DATADIR="./")

find_package(FLEX)
FLEX_TARGET(lexer nvc/src/lexer.l ${CMAKE_CURRENT_BINARY_DIR}/lexer.c)
# OSX needed a hint
find_library(FLEX_LIBRARY fl HINTS /usr/local/opt/flex/lib)
